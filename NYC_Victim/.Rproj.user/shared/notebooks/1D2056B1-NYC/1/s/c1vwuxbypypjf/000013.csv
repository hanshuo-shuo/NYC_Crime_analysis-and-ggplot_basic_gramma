"0","#| label: plot_miss"
"0","#| echo: false"
"0","#| fig-width: 30"
"0","#| fig-height: 15"
"0",""
"0","# load Package"
"0","library(dplyr)"
"0","library(ggplot2)"
"0","library(tidyverse)"
"0","library(patchwork)"
"0","library(cowplot)"
"0","library(ggalluvial)"
"0","library(base)"
"0","# load dateset"
"0","data <- read.csv(""data/NYPD_Complaint_Data_Historic.csv"", na.strings = c("""", ""NA""))"
"0",""
"0","missing_plot_func <- function(inputdata, option) {"
"0","  mycars <- inputdata"
"0","  n_vars <- ncol(mycars)"
"0","  n_rows <- nrow(mycars)"
"0","  if (option == ""counts"") {"
"0","    # create missing pattern"
"0","    missing_patterns <- data.frame(is.na(mycars)) %>%"
"0","      group_by_all() %>%"
"0","      count(name = ""count"", sort = TRUE) %>%"
"0","      ungroup()"
"0","    n_rows <- nrow(missing_patterns)"
"0",""
"0","    # side plots"
"0","    missing.values <- mycars %>%"
"0","      select(everything()) %>% # replace to your needs"
"0","      summarise_all(funs(sum(is.na(.)))) %>%"
"0","      gather(key = ""key"", value = ""val"") %>%"
"0","      arrange(desc(val))"
"0",""
"0","    s1 <- missing.values %>%"
"0","      ggplot() +"
"0","      geom_bar(aes(x = reorder(key, -val), y = val), fill = ""red"", stat = ""identity"") +"
"0","      labs(x = ""variable"", y = ""number of missing values"", title = ""Missing value pattern"") +"
"0","      theme(axis.text.x = element_text(angle = 45, hjust = 1))"
"0",""
"0","    missing_patterns_withAP <- missing_patterns"
"0","    selected <-"
"0","      which(apply(missing_patterns[, -length(missing_patterns)], 1, any) == F[1])"
"0","    alpha_vector <- rep(1, nrow(missing_patterns_withAP))"
"0","    alpha_vector[selected] <- 2"
"0","    missing_patterns_withAP$hl_alpha <- alpha_vector"
"0",""
"0","    missing_patterns_withAP[""id""] <- as.factor(seq(1, n_rows))"
"0","    s2_y <- fct_reorder(missing_patterns_withAP$id,"
"0","      as.numeric(missing_patterns_withAP$id),"
"0","      .desc = TRUE"
"0","    )"
"0",""
"0",""
"0","    s2 <- missing_patterns_withAP %>%"
"0","      ggplot() +"
"0","      geom_bar(aes("
"0","        x = count,"
"0","        fill = ""red"","
"0","        s2_y,"
"0","        alpha = hl_alpha"
"0","      ), stat = ""identity"") +"
"0","      scale_alpha(range = c(0.45, 1)) +"
"0","      labs(x = ""row count"", y = """") +"
"0","      theme("
"0","        axis.text.x = element_text(angle = 45, hjust = 1),"
"0","        legend.position = ""none"""
"0","      )"
"0","    missing_patterns_cleaned <- select(missing_patterns, -count)"
"0","    selected <-"
"0","      which(apply(missing_patterns[, -length(missing_patterns)], 1, any) == F[1])"
"0","  }"
"0",""
"0","  if (option == ""percent"") {"
"0","    missing_patterns <- data.frame(is.na(mycars)) %>%"
"0","      group_by_all() %>%"
"0","      count(name = ""count"", sort = TRUE) %>%"
"0","      ungroup() %>%"
"0","      mutate(pct = count / nrow(mycars))"
"0","    # side 1 col"
"0","    missing.values <- mycars %>%"
"0","      select(everything()) %>% # replace to your needs"
"0","      summarise_all(funs(sum(is.na(.)))) %>%"
"0","      gather(key = ""key"", value = ""val"") %>%"
"0","      mutate(pct = val / n_rows) %>%"
"0","      arrange(desc(pct))"
"0",""
"0","    #    print(missing_patterns)"
"0","    n_rows <- nrow(missing_patterns)"
"0",""
"0","    s1 <- missing.values %>%"
"0","      ggplot() +"
"0","      geom_bar(aes(x = reorder(key, -pct), y = pct), fill = ""blue"", stat = ""identity"") +"
"0","      labs(x = ""Variables"", y = ""Percentage of Missing"", title = ""Missing value pattern"") +"
"0","      theme(axis.text.x = element_text(angle = 45, hjust = 1))"
"0",""
"0",""
"0","    missing_patterns_withAP <- missing_patterns"
"0","    selected <-"
"0","      which(apply(missing_patterns[1:n_vars], 1, any) == F[1])"
"0","    alpha_vector <- rep(1, nrow(missing_patterns_withAP))"
"0","    alpha_vector[selected] <- 2"
"0","    missing_patterns_withAP$hl_alpha <- alpha_vector"
"0",""
"0","    missing_patterns_withAP[""id""] <- as.factor(seq(1, n_rows))"
"0","    s2_y <- fct_reorder(missing_patterns_withAP$id,"
"0","      as.numeric(missing_patterns_withAP$id),"
"0","      .desc = TRUE"
"0","    )"
"0",""
"0",""
"0","    s2 <- missing_patterns_withAP %>%"
"0","      ggplot() +"
"0","      geom_bar(aes("
"0","        x = pct,"
"0","        fill = ""blue"","
"0","        s2_y,"
"0","        alpha = hl_alpha"
"0","      ), stat = ""identity"") +"
"0","      scale_alpha(range = c(0.45, 1)) +"
"0","      labs(x = ""row percentage"", y = """") +"
"0","      theme("
"0","        axis.text.x = element_text(angle = 45, hjust = 1),"
"0","        legend.position = ""none"""
"0","      ) + "
"0","      theme_classic()"
"0",""
"0","    missing_patterns_cleaned <-"
"0","      select(missing_patterns, -c(count, pct))"
"0",""
"0","    selected <-"
"0","      which(apply(missing_patterns[, -c(length(missing_patterns), length(missing_patterns) -"
"0","        1)], 1, any) == F[1])"
"0","  }"
"0","  "
"0","  # create main plot"
"0","  missing_patterns_modified <- missing_patterns_cleaned %>%"
"0","    rownames_to_column(""id"") %>%"
"0","    gather(key, value, -id) %>%"
"0","    mutate(missing = ifelse(value == 1, 1, 0)) %>%"
"0","    mutate(missing_patterns[id, ""count""])"
"0",""
"0","  missing_patterns_merged <-"
"0","    merge("
"0","      x = missing.values,"
"0","      y = missing_patterns_modified,"
"0","      by = ""key"","
"0","      all = TRUE"
"0","    )"
"0",""
"0","  y <- fct_reorder(missing_patterns_merged$id,"
"0","    as.numeric(missing_patterns_merged$id),"
"0","    .desc = TRUE"
"0","  )"
"0","  "
"0","  alpha_vector <- rep(1, nrow(missing_patterns_merged))"
"0","  highlight <-"
"0","    as.vector(which(missing_patterns_merged$id == selected))"
"0",""
"0","  alpha_vector[highlight] <- 2"
"0","  missing_patterns_merged$hl_alpha <- alpha_vector"
"0",""
"0","  main <-"
"0","    ggplot("
"0","      missing_patterns_merged,"
"0","      aes("
"0","        x = fct_reorder(key, val, .desc = TRUE),"
"0","        y,"
"0","        fill = as.factor(missing),"
"0","        alpha = hl_alpha"
"0","      )"
"0","    ) +"
"0","    geom_tile(color = ""white"") +"
"0","    scale_fill_manual(values = c(""grey"", ""mediumpurple"")) +"
"0","    scale_alpha(range = c(0.45, 1)) +"
"0","    theme_bw() +"
"0","    labs(x = ""variables"", y = ""Missing"") +"
"0","    theme("
"0","      legend.position = ""none"","
"0","      axis.text.x = element_text(angle = 45, hjust = 1)"
"0","    )"
"0","#plot"
"0","main"
"0","}"
"0",""
"0","data <- data"
"0",""
"0","missing_plot_func(data, ""percent"")"
